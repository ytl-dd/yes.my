<style type="text/css">
    .popfixed {
        z-index: 1000;
        position: fixed;
        width: 100%;
        bottom: 0;
        left: 0;
        padding: 30px 15px 20px;
        background-color: rgba(250, 250, 250, 0.95)
    }
    
    .popfixed .ttl {
        color: #ec008c;
        font-size: 18px;
        margin-bottom: 15px
    }
    
    .popfixed p {
        font-size: 16px;
        margin-bottom: 10px
    }
    
    .popfixed .closee {
        position: absolute;
        right: 15px;
        top: 15px;
        cursor: pointer;
        z-index: 100
    }
    
    .showw {
        display: none
    }
    
    @media (max-width:1000px) {
        .popfixed {
            padding: 20px 15px 15px;
        }
        .popfixed .ttl {
            font-size: 16px;
            margin-bottom: 10px
        }
        .popfixed p {
            font-size: 13px;
            margin-bottom: 7px
        }
    }
    
    .support-sect.store-locator .status-message-hdr {
        z-index: 100;
    }
    
    .search-bar-field {
        color: #333;
    }
    
    .store-link,
    .light .store-link {
        color: #ec008c;
    }
</style>


<div class="popfixed filterDiv closee">
    <div class="closee" onclick="filterSelection('close')"><svg class="ia ia-close" style="color:#000000"> <use xlink:href="#ia-close"></use> </svg></div>

    <div style="max-width:1100px; margin:0 auto; position:relative">
        <div class="ttl"><b>Temporary change of operating hours.</b></div>

        <p>In line with the implementation of Recovery&nbsp;Movement Control Order (RMCO), please be informed only selected Y E S stores will be operating at a revised hour.</p>

        <p>Click <a href="https://www.yes.my/support/outletannouncement" style="color:#ec008c; text-decoration:underline">here</a> to find out more.</p>
    </div>
</div>

<section class="dblock flexbox light">
    <div>
        <div class="content-sect support-sect store-locator">
            <div class="content-body-sect">
                <div id="store-locator-mobile-mq">&nbsp;</div>

                <div class="wrapper">
                    <div class="utilities-hdr">
                        <div class="search-bar">
                            <div class="search-bar-form"><input class="search-bar-field" id="storeAutocomplete" placeholder="Find a store near you" type="search" /><button class="search-bar-submit" id="toggleAutocomplete" title="Search" type="button"></button></div>

                            <div class="location-btn-hdr"><button class="location-btn" id="toggleGeolocation" title="Go to your current location" type="button"></button></div>

                            <div class="filters-btn-hdr"><button class="filters-btn" id="toggleFilters" type="button">Filters</button></div>
                        </div>

                        <div class="status-message-hdr" id="statusMessage"><button class="status-message-closer" id="statusMessageCloser" type="button">×</button>

                            <div class="status-message" id="statusMessageBody">Sample status message.</div>
                        </div>
                    </div>

                    <div class="filter-hdr" id="storeFilters"><button class="filter-closer" type="button">×</button>

                        <div class="filter-header"><button class="textlink" id="showAllStores" type="button">Show All <span class="small-text"><span id="totalStores">-</span> stores</span></button></div>

                        <div class="filter-types">
                            <div class="filter-type"><button class="filter-type-trigger" style="color:#b4b4b4;" type="button">By State</button>

                                <div class="filter-type-content-hdr">
                                    <div class="filter-type-content">
                                        <div class="custom-radio" id="stateInputHdr"><label for="state0"><input checked="checked" class="js-state" id="state0" name="state" type="radio" value="all" />All</label></div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-type"><button class="filter-type-trigger" style="color:#b4b4b4;" type="button">By Outlet</button>

                                <div class="filter-type-content-hdr">
                                    <div class="filter-type-content">
                                        <div class="custom-radio"><label for="outlet0"><input checked="checked" class="js-outlet-type" id="outlet0" name="outlet" type="radio" value="all" />All</label> <label for="outlet6"><input class="js-outlet-type" data-url="/xml/yes-premium-stores.xml" id="outlet6" name="outlet" type="radio" value="yespremiumstores" />Yes Store &amp; Service Centre </label>
                                            <label for="outlet7"><input class="js-outlet-type" data-url="/xml/yes-stores.xml" id="outlet7" name="outlet" type="radio" value="yestore" />Yes Store</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-type"><button class="filter-type-trigger" style="color:#b4b4b4;" type="button">Products &amp; Services</button>

                                <div class="filter-type-content-hdr">
                                    <div class="filter-type-content">
                                        <div class="custom-radio" id="serviceInputHdr"><label for="service0"><input checked="checked" class="js-service" id="service0" name="service" type="radio" value="all" />All</label></div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-type filter-store-list">
                                <div class="store-list" id="storeList">&nbsp;</div>
                            </div>
                            sdfghjhgf</div>
                    </div>
                </div>

                <div class="store-map-sect">
                    <div class="infobox" id="storeInfobox">
                        <div class="infobox-panel"><button class="infobox-closer" title="Close" type="button"></button>

                            <div class="infobox-store-details">&nbsp;</div>
                        </div>

                        <div class="infobox-actions">&nbsp;</div>
                    </div>

                    <div class="store-map" id="storeMap">&nbsp;</div>
                </div>

                <div class="store-body-sect">
                    <div class="wrapper">
                        <div class="infobox mobile" id="storeMobileInfobox">
                            <div class="infobox-panel"><button class="infobox-closer" title="Close" type="button"></button>

                                <div class="infobox-store-details">
                                    <div class="store-detail-header">Yes Mobile Kiosk,<br /> Digital Mall PJ</div>

                                    <div class="store-detail-section">K-G19A, Ground Floor, Digital Mall PJ<br /> No.2, Jalan 14/20, Section 14,<br /> 46100 Petaling Jaya, Selangor.</div>

                                    <div class="store-detail-section small-text"><i>Opens 10.30am - 9pm on Sunday till Friday<br />
    Opens 10.30am - 10pm on Saturday </i></div>

                                    <div class="store-detail-section uppercase">Products &amp; Services</div>

                                    <div class="store-detail-section">
                                        <ul>
                                            <li>Smartphones</li>
                                            <li>YesPlan + SIM Replacement</li>
                                            <li>24-hour Payment Kiosk</li>
                                            <li>Bill Payment</li>
                                            <li>Credit Card Payment</li>
                                            <li>Installment Plan</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="infobox-actions"><a class="infobox-action" href="#/">Get Directions</a></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<script type="text/javascript">
    filterSelection("none")

    function filterSelection(c) {
        var x, i;
        x = document.getElementsByClassName("filterDiv");
        if (c == "all") c = "";
        for (i = 0; i < x.length; i++) {
            w3RemoveClass(x[i], "show");
            if (x[i].className.indexOf(c) > -1) w3AddClass(x[i], "showw");
        }
    }

    function w3AddClass(element, name) {
        var i, arr1, arr2;
        arr1 = element.className.split(" ");
        arr2 = name.split(" ");
        for (i = 0; i < arr2.length; i++) {
            if (arr1.indexOf(arr2[i]) == -1) {
                element.className += " " + arr2[i];
            }
        }
    }

    function w3RemoveClass(element, name) {
        var i, arr1, arr2;
        arr1 = element.className.split(" ");
        arr2 = name.split(" ");
        for (i = 0; i < arr2.length; i++) {
            while (arr1.indexOf(arr2[i]) > -1) {
                arr1.splice(arr1.indexOf(arr2[i]), 1);
            }
        }
        element.className = arr1.join(" ");
    }
</script>

<script type="text/javascript" src="https://maps.google.com/maps/api/js?libraries=places,visualization&v=weekly&client=gme-ytlcommunications3&channel=publicyes"></script>
<script type="text/javascript" src="/wp-content/themes/yes.my/js/infobox.packed.js"></script>
<script type="text/javascript">
    window.onload = function() {
        (function($) {
            $(function() {

                var $map = $('#storeMap'),
                    $autocompleter = $('#storeAutocomplete'),
                    $autocompleteTrigger = $('#toggleAutocomplete'),
                    $infobox = $('#storeInfobox'),
                    $mobileInfobox = $('#storeMobileInfobox'),
                    $geolocationTrigger = $('#toggleGeolocation'),
                    $statusMessage = $('#statusMessage'),
                    $statusMessageBody = $('#statusMessageBody'),
                    $statusMessageCloser = $('#statusMessageCloser'),

                    defaultLatLng = {
                        lat: 4.210484,
                        lng: 101.975766
                    },
                    messages = {
                        cantLocateUser: 'We\'re having trouble locating you. Try using our search and filter functions instead.',
                        notAllowedLocation: 'Please enable the location service on your device.',
                        generalError: 'We\'ve encountered an error. Please try again later.'
                    },

                    imageUserPin = '../images/yes2018/Group 2211-blue.png',
                    imageStorePin = '../images/yes2018/Group 2211.png';


                var outletTypeValues = [],
                    serviceList = [],
                    stateList = [],
                    queryStrProps,
                    animator;


                var $mobileMq = $('#store-locator-mobile-mq'),
                    mobileMq = false;

                $(window)
                    .on('resize.storeMobileMq', function() {
                        mobileMq = $mobileMq.css('font-family').indexOf('true') > -1;
                    })
                    .triggerHandler('resize.storeMobileMq');

                var dataLoader = {
                    init: function() {
                        var self = this,
                            $outletTypes = $('.js-outlet-type');

                        $outletTypes.each(function() {
                            if (typeof $(this).data('url') !== 'string' || $(this).val() === '') {
                                $outletTypes = $outletTypes.not(this);
                            }
                        });

                        self.total = $outletTypes.length;
                        self.count = 0;

                        $outletTypes.each(function() {
                            self.load($(this));
                        });
                    },

                    load: function($input) {
                        var self = this;

                        $.ajax({
                            type: 'GET',
                            url: $input.data('url'),
                            dataType: 'xml',
                            success: function(data) {
                                prepData(data, $input);
                                self.count++;

                                if (self.count >= self.total) {
                                    initPage();
                                }


                            },
                            error: function(d) {
                                console.log(d);
                            }
                        });
                    }
                };

                var xmlData = {};

                function prepData(data, $input) {
                    var obj = {};

                    $(data).find('state').each(function() {
                        var stateName = $(this).attr('stateName'),
                            stateObj = xmlData[stateName];

                        if (!stateObj) {
                            xmlData[stateName] = stateObj = {};
                        }

                        var outletObj = stateObj[$input.val()];

                        if (!outletObj) {
                            stateObj[$input.val()] = outletObj = [];
                        }

                        if (stateList.indexOf(stateName) < 0) {
                            stateList.push(stateName);
                        }

                        $(this).find('shop').each(function() {
                            outletObj.push(prepShopData($(this)));
                        });
                    });

                    xmlData[$input.val()] = obj;
                }

                function prepShopData($shop) {
                    var shopObj = {};

                    $shop.children().each(function() {
                        switch (this.tagName) {
                            case 'shopLat':
                            case 'shopLng':
                                shopObj[this.tagName] = $(this).text().trim();

                                if (shopObj.shopLat && shopObj.shopLat !== '0' &&
                                    shopObj.shopLng && shopObj.shopLng !== '0') {
                                    shopObj.latLng = new google.maps.LatLng(shopObj.shopLat, shopObj.shopLng);
                                }
                                break;

                            case 'shopService':
                                var serviceArr = [];

                                $(this).find('serviceList').each(function() {
                                    var serviceListText = $(this).text().trim();

                                    if (!serviceListText) {
                                        return;
                                    }

                                    serviceArr.push(serviceListText);

                                    if (serviceList.indexOf(serviceListText) < 0) {
                                        serviceList.push(serviceListText);
                                    }
                                });

                                shopObj[this.tagName] = serviceArr;
                                break;

                            default:
                                shopObj[this.tagName] = $(this).text().trim();
                                break;
                        }
                    });

                    return shopObj;
                }

                var map = {
                    $el: $map,

                    storeMarkers: [],
                    markerClickers: [],

                    init: function() {
                        var self = this;

                        self.instance = new google.maps.Map(self.$el[0], {
                            center: defaultLatLng,
                            // zoom: 18
                            zoom: 8,
                            scrollwheel: false,
                            mapTypeControl: false,
                            streetViewControl: false
                        });
                    },

                    setMainMarker: function(latLng, title) {
                        var self = this;

                        self.clearMainMarker();

                        self.mainMarker = new google.maps.Marker({
                            position: latLng,
                            map: self.instance,
                            title: title,
                            icon: imageUserPin
                        });

                        self.instance.setCenter(latLng);

                        if (self.instance.getZoom() < 14) {
                            self.instance.setZoom(14);
                        }

                        self.mainMarkerClicker = google.maps.event.addListener(self.mainMarker, 'click', function() {
                            self.instance.setCenter(self.mainMarker.getPosition());
                        });
                    },

                    clearMainMarker: function() {
                        var self = this;

                        if (self.mainMarkerClicker) {
                            google.maps.event.removeListener(self.mainMarkerClicker);
                            self.mainMarkerClicker = undefined;
                        }

                        if (self.mainMarker) {
                            self.mainMarker.setMap(null);
                            self.mainMarker = undefined;
                        }
                    },

                    findStores: function(center, distance) {
                        var self = this;

                        if (self.storeMarkers.length) {
                            self.clearStores();
                        }

                        statusMessage.close();
                        infobox.hideBox();
                        storeFilter.filterStores(center, distance);
                        self.addStores(storeFilter.result);

                        if (storeFilter.result.length) {
                            $('#noStores').hide();
                            $('#storeList').empty().show().html(strBuilder.makeStoreListStr(storeFilter.result));
                            heightSync.watch('storeList', $('#storeList').find('.store-details-hdr'));
                            heightSync.sync();

                            if (storeFilter.result.length === 1) {
                                infobox.showBox(0, self.storeMarkers[0]);
                            } else if (storeFilter.result.length > 50) {
                                var markersInterval;

                                $(window).one('done', function() {
                                    self.fitMarkersInView((center) ? 'includeMarker' : undefined);
                                    clearInterval(markersInterval);
                                });

                                setTimeout(function() {
                                    self.fitMarkersInView((center) ? 'includeMarker' : undefined);

                                    markersInterval = setInterval(function() {
                                        self.fitMarkersInView((center) ? 'includeMarker' : undefined);
                                    }, 2000);
                                }, 250);
                            } else {
                                self.fitMarkersInView((center) ? 'includeMarker' : undefined);
                            }
                        } else {
                            $('#noStores').show();
                            $('#storeList').hide().empty();
                        }
                    },

                    addStores: function(storesArr) {
                        var self = this;

                        cancelAnimationFrame(animator);
                        $(window).trigger('done');

                        if (storesArr.length > 50) {
                            var subStoresArr,
                                i = 0,
                                draw = function() {
                                    var subStoresArr = storesArr.slice(i, i + 4);

                                    for (j = 0; j < subStoresArr.length; j++) {
                                        self.addStoreMarker(subStoresArr[j], j);
                                    }

                                    i += 4;

                                    if (i >= storesArr.length) {
                                        $(window).trigger('done');
                                    } else {
                                        animator = requestAnimationFrame(draw);
                                    }
                                };

                            draw();
                        } else {
                            for (var i = 0; i < storesArr.length; i++) {
                                self.addStoreMarker(storesArr[i], i);
                            }
                        }
                    },

                    addStoreMarker: function(storeObj, index) {
                        if (!storeObj.latLng) return;

                        var self = this,
                            marker = new google.maps.Marker({
                                position: storeObj.latLng,
                                map: self.instance,
                                title: storeObj.shopName,
                                icon: imageStorePin
                            });

                        self.storeMarkers.push(marker);

                        self.markerClickers.push(
                            google.maps.event.addListener(marker, 'click', function() {
                                infobox.showBox(storeObj, marker);
                            })
                        );
                    },

                    clearStores: function() {
                        var self = this;

                        while (self.markerClickers.length) {
                            google.maps.event.removeListener(self.markerClickers.pop());
                        }

                        while (self.storeMarkers.length) {
                            self.storeMarkers.pop().setMap(null);
                        }
                    },

                    fitMarkersInView: function(includeMarker) {
                        var self = this,
                            bounds = new google.maps.LatLngBounds();

                        for (var i = 0; i < self.storeMarkers.length; i++) {
                            bounds.extend(self.storeMarkers[i].getPosition());
                        }

                        if (self.mainMarker && includeMarker) {
                            bounds.extend(self.mainMarker.getPosition());
                        }

                        self.instance.fitBounds(bounds);
                    }
                };

                var storeFilter = {
                    result: [],

                    state: undefined,
                    outletType: undefined,
                    service: undefined,
                    distance: undefined,

                    filterStores: function(center, distance) {
                        var self = this,
                            _result = [],
                            i;

                        self.updateCriteria(distance);

                        var lists = [];

                        $.each(xmlData, function(stateName, outletTypeObj) {
                            if (!self.state || self.state === 'all' || self.state === stateName) {
                                $.each(outletTypeObj, function(outletType, stores) {
                                    if (!self.outletType || self.outletType === 'all' || self.outletType === outletType) {
                                        for (i = 0; i < stores.length; i++) {
                                            if (self.isMatchingCriteria(center, stores[i])) {
                                                var key = stores[i].shopAddress + '|' + stores[i].shopLat + '|' + stores[i].shopLng;

                                                if (lists.indexOf(key) === -1) {
                                                    _result.push(stores[i]);
                                                    lists.push(key);
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        });

                        _result.sort(ascendingDistance);

                        self.result = _result;
                    },

                    updateCriteria: function(distance) {
                        var self = this;

                        self.state = $('.js-state:checked').val();
                        self.outletType = $('.js-outlet-type:checked').val();
                        self.service = $('.js-service:checked').val();
                        self.distance = distance;
                    },

                    clearCriteria: function() {
                        $('#storeFilters').find('input[value="all"]').prop('checked', true);
                    },

                    isMatchingCriteria: function(center, storeObj) {
                        var self = this;

                        return self.hasLatLng(storeObj) &&
                            self.isWithinDistance(center, storeObj) &&
                            self.isMatchingService(storeObj);
                    },

                    hasLatLng: function(storeObj) {
                        return storeObj.latLng;
                    },

                    isWithinDistance: function(center, storeObj) {
                        var self = this;

                        if (typeof center === 'undefined' || typeof self.distance === 'undefined') {
                            return true;
                        } else {
                            storeObj.distance = distHaversine(center, storeObj.latLng);
                            return storeObj.distance < self.distance;
                        }
                    },

                    isMatchingService: function(storeObj) {
                        var self = this;

                        console.log(self.service);

                        if (!self.service || self.service === 'all') {
                            return true;
                        } else {
                            return storeObj.shopService.indexOf(self.service) > -1;
                        }
                    }
                };

                var strBuilder = {
                    markups: {
                        details: [
                            '<div class="store-detail-header">',
                            '{{name}}',
                            '</div>',
                            '<div class="store-detail-section address">',
                            '{{address}}',
                            '</div>',
                            '<div class="store-detail-section small-text opHour">',
                            '<i>',
                            '{{opHour}}',
                            '</i>',
                            '</div>',
                            '<div class="store-detail-section uppercase category">',
                            'Products &amp; Services',
                            '</div>',
                            '<div class="store-detail-section serviceList">',
                            '{{serviceList}}',
                            '</div>'
                        ],
                        infoboxAction: [
                            '<a href="', '{{getDirection}}', '" target="_blank" class="infobox-action">Get Directions</a>'
                        ],
                        detailsActions: [
                            '<div class="store-detail-section">',
                            '<a href="', '{{getDirection}}', '" target="_blank" class="store-link store-get-direction-link">Get Direction</a>',
                            '</div>'
                        ],
                        store: [
                            '<div class="store-hdr">',
                            '<div class="store-distance">{{distance}}</div><div class="store-index">{{index}}</div>',
                            '<div class="store-details-hdr">',
                            '{{storeDetails}}',
                            '</div>',
                            '{{storeDetailsAction}}',
                            '</div>'
                        ],
                        radio: '<label for="{{id}}"><input checked="checked" class="{{cssClass}}" id="{{id}}" name="{{name}}" type="radio" value="{{value}}" />{{label}}</label>'
                    },

                    makeStoreListStr: function(stores) {
                        var self = this,
                            str = '';

                        for (var i = 0; i < stores.length; i++) {
                            var tmp = self.makeStoreStr(stores[i]);

                            tmp = tmp.replace("{{index}}", i + 1);
                            tmp = tmp.replace("{{distance}}", stores[i].distance + ' km');

                            str += tmp;
                        }

                        return str;
                    },

                    makeStoreStr: function(storeObj) {
                        var self = this,
                            storeMarkup = self.markups.store.slice(0),
                            actionsMarkup = self.markups.detailsActions.slice(0);
                        replaceStr(storeMarkup, '{{storeDetails}}', self.makeDetailsStr(storeObj));
                        if (storeObj.shopLat === '0' || storeObj.shopLng === '0') {
                            actionsMarkup = [];
                        } else {
                            replaceStr(actionsMarkup, '{{getDirection}}', self.makeDirectionsUrl(storeObj));
                        }
                        replaceStr(storeMarkup, '{{storeDetailsAction}}', actionsMarkup.join(''));

                        return storeMarkup.join('');
                    },

                    makeDetailsStr: function(storeObj) {
                        var self = this,
                            params = {
                                name: storeObj.shopName,
                                address: storeObj.shopAddress,
                                opHour: storeObj.shopOpHour,
                                serviceList: self.makeServiceListStr(storeObj.shopService),
                            },
                            detailsMarkup = self.markups.details.slice(0);

                        $.each(params, function(key, val) {
                            replaceStr(detailsMarkup, '{{' + key + '}}', val);
                        });

                        return detailsMarkup.join('');
                    },

                    makeInfoboxActionsStr: function(storeObj) {
                        var self = this,
                            actionsMarkup = self.markups.infoboxAction.slice(0);

                        replaceStr(actionsMarkup, '{{getDirection}}', self.makeDirectionsUrl(storeObj));

                        return actionsMarkup.join('');
                    },

                    makeDirectionsUrl: function(storeObj) {
                        var from, to;

                        if (map.mainMarker) {
                            from = {
                                lat: map.mainMarker.getPosition().lat(),
                                lng: map.mainMarker.getPosition().lng()
                            };
                        }

                        to = {
                            lat: storeObj.shopLat,
                            lng: storeObj.shopLng
                        };

                        if (from) {
                            return [
                                'https://maps.google.com?',
                                'saddr=', from.lat, ',', from.lng,
                                '&daddr=', to.lat, ',', to.lng,
                            ].join('');
                        } else {
                            return [
                                'https://maps.google.com?',
                                'daddr=', to.lat, ',', to.lng,
                            ].join('');
                        }
                    },

                    makeServiceListStr: function(serviceArr) {
                        if (serviceArr != undefined) {
                            var listStr = ['<ul>', 1, '</ul>'];

                            listStr[1] = '';
                            for (var i = 0; i < serviceArr.length; i++) {
                                listStr[1] += '<li>' + serviceArr[i] + '</li>';
                            }

                            return listStr.join('');
                        }
                    },

                    makeRadioStr: function(params) {
                        var radioMarkup = this.markups.radio;

                        $.each(params, function(key, val) {
                            radioMarkup = radioMarkup.replace('{{' + key + '}}', val).replace('{{' + key + '}}', val);
                        });

                        return radioMarkup;
                    }
                };

                var infobox = {
                    $el: $infobox,
                    $mobileEl: $mobileInfobox,

                    init: function() {
                        var self = this;

                        self.instance = new InfoBox({
                            content: self.$el[0],
                            pixelOffset: new google.maps.Size(45, -125),
                            closeBoxURL: ''
                        });

                        $('.infobox-closer').on('click', function(e) {
                            e.preventDefault();
                            self.hideBox();
                        });
                    },

                    showBox: function(storeObj, markerObj) {
                        var self = this;

                        self.updateDetails(storeObj);
                        self.$el.addClass('is-active');
                        self.$mobileEl.addClass('is-active');
                        self.instance.open(map.instance, markerObj);
                        map.instance.setCenter(markerObj.getPosition());
                        if (!mobileMq) {
                            map.instance.panBy(100, 75);
                        }
                    },

                    hideBox: function() {
                        var self = this;

                        self.$el.removeClass('is-active');
                        self.$mobileEl.removeClass('is-active');
                        self.instance.close();
                    },

                    updateDetails: function(storeObj) {
                        var self = this;

                        self.$el.add(self.$mobileEl).find('.infobox-store-details').html(
                            strBuilder.makeDetailsStr(storeObj)
                        );

                        self.$el.add(self.$mobileEl).find('.infobox-actions').html(
                            strBuilder.makeInfoboxActionsStr(storeObj)
                        );
                    }
                };
                var autocompleter = {
                    $el: $autocompleter,
                    $trigger: $autocompleteTrigger,

                    init: function() {
                        var self = this;

                        self.$el = $autocompleter;

                        self.instance = new google.maps.places.Autocomplete(self.$el[0], {
                            componentRestrictions: {
                                country: 'my'
                            }
                        });

                        google.maps.event.addListener(self.instance, 'place_changed', function() {
                            var placeObj = self.instance.getPlace();

                            map.setMainMarker(placeObj.geometry.location, placeObj.name);
                            storeFilter.clearCriteria();
                            map.findStores(map.mainMarker.getPosition(), 5);
                        });

                        self.$trigger.on('click', function(e) {
                            var placeObj = self.instance.getPlace();

                            if (!placeObj) {
                                self.$el.focus();
                            } else {
                                map.setMainMarker(placeObj.geometry.location, placeObj.name);
                                storeFilter.clearCriteria();
                                map.findStores(map.mainMarker.getPosition(), 5);
                            }
                        });
                    }
                };
                var geolocator = {
                    $trigger: $geolocationTrigger,

                    init: function() {
                        var self = this;

                        self.$trigger.on('click', function(e) {
                            e.preventDefault();
                            self.watch();
                        });

                    },

                    watch: function() {
                        var self = this;

                        if (self.instance) {
                            return;
                        }

                        self.$trigger.addClass('is-running');
                        statusMessage.close();

                        self.instance = navigator.geolocation.watchPosition(
                            function(position) {
                                self.stop();

                                map.setMainMarker(
                                    new google.maps.LatLng(
                                        position.coords.latitude,
                                        position.coords.longitude
                                    ),
                                    'Your current location'
                                );

                                storeFilter.clearCriteria();
                                map.findStores(map.mainMarker.getPosition(), 5);
                            },

                            function(error) {
                                self.stop();

                                switch (error.code) {
                                    case error.TIMEOUT:
                                        statusMessage.open('cantLocateUser');
                                        break;

                                    default:
                                        statusMessage.open('notAllowedLocation');
                                        break;
                                }
                            },

                            {
                                enableHighAccuracy: true,
                                maximumAge: 30000,
                                timeout: 15000
                            }
                        );

                        self.timer = setTimeout(function() {
                            self.stop();
                            statusMessage.open('notAllowedLocation');
                        }, 20000);
                    },

                    stop: function() {
                        var self = this;

                        self.$trigger.removeClass('is-running');
                        navigator.geolocation.clearWatch(self.instance);
                        self.instance = undefined;
                        clearTimeout(self.timer);
                        self.timer = undefined;
                    }
                };

                var statusMessage = {
                    $el: $statusMessage,
                    $body: $statusMessageBody,
                    $closer: $statusMessageCloser,
                    messages: messages,

                    init: function() {
                        var self = this;

                        self.$closer.on('click', function(e) {
                            e.preventDefault();
                            self.close();
                        });
                    },

                    open: function(key) {
                        var self = this;
                        self.$body.html(messages[key]);
                        self.$el.slideDown(250);
                    },

                    close: function() {
                        this.$el.slideUp(250);
                    }
                };

                var heightSync = {
                    targets: {},

                    init: function() {
                        var self = this;

                        $(window)
                            .on('resize.heightSync', function() {
                                self.sync();
                            })
                            .triggerHandler('resize.heightSync');
                    },

                    watch: function(key, $el) {
                        this.targets[key] = $el;
                    },

                    unwatch: function(key) {
                        delete this.targets[key];
                    },

                    sync: function() {
                        var self = this;

                        $.each(self.targets, function(key, $el) {
                            self.syncGroup($el);
                        });
                    },

                    syncGroup: function($el) {
                        var total = $el.length;
                        if (total > 50) return;

                        var self = this,
                            leftOffset = -9999,
                            row = [];

                        $el.each(function(index) {
                            var targetLeftOffset = $(this).offset().left;

                            if (targetLeftOffset > leftOffset) {
                                row.push(this);
                            } else {
                                self.syncRow(row);
                                row = [this];
                            }

                            leftOffset = targetLeftOffset;

                            if (index >= total - 1) {
                                self.syncRow(row);
                            }
                        });
                    },

                    syncRow: function(elArr) {
                        var maxHeight = [];

                        $(elArr).each(function() {
                            $(this).height('');
                            maxHeight.push($(this).outerHeight());
                        });

                        maxHeight = Math.max.apply(null, maxHeight);

                        $(elArr).height(maxHeight);
                    }
                };

                dataLoader.init();

                function initPage() {
                    queryStrProps = queryStr();

                    populateFilterInput();
                    $('#totalStores').text(getTotalStores());

                    $('#showAllStores').on('click', function(e) {
                        storeFilter.clearCriteria();
                        map.findStores();
                        hideStoreFilters();
                    });

                    map.init();
                    infobox.init();
                    autocompleter.init();
                    geolocator.init();
                    statusMessage.init();
                    heightSync.init();

                    $("input[name=state],input[name=outlet]").change(function() {

                        $('.filter-type.is-active').removeClass("is-active").find('.filter-type-content-hdr').slideUp(250);
                    });

                    if (queryStrProps.outlet) {
                        $('.js-outlet-type[value="' + queryStrProps.outlet + '"]').prop('checked', true);
                        map.findStores();
                    } else {
                        geolocator.watch();
                    }
                }

                function populateFilterInput() {
                    var serviceRadioStr = '',
                        i;

                    for (i = 0; i < serviceList.length; i++) {
                        serviceRadioStr += strBuilder.makeRadioStr({
                            'id': 'service' + (i + 1),
                            name: 'service',
                            cssClass: 'js-service',
                            value: serviceList[i],
                            label: serviceList[i]
                        });
                    }

                    $('#serviceInputHdr').append(serviceRadioStr);

                    var stateRadioStr = '';

                    for (i = 0; i < stateList.length; i++) {
                        stateRadioStr += strBuilder.makeRadioStr({
                            id: 'state' + (i + 1),
                            name: 'state',
                            cssClass: 'js-state',
                            value: stateList[i],
                            label: stateList[i]
                        });
                    }

                    $('#stateInputHdr').append(stateRadioStr);

                    $('#storeFilters').find('input[type="radio"]').on('change', function(e) {
                        map.clearMainMarker();
                        map.findStores();
                        hideStoreFilters();
                    });
                }

                function getTotalStores() {
                    var count = 0;

                    $.each(xmlData, function(stateName, outletTypeObj) {
                        $.each(outletTypeObj, function(outletType, stores) {
                            count += stores.length;
                        });
                    });

                    return count;
                }

                $('.filter-types').each(function() {
                    var $filters = $(this).find('.filter-type');

                    $filters.each(function(index) {
                        $(this).find('.filter-type-trigger').on('click', function(e) {
                            e.preventDefault();

                            if ($filters.eq(index).hasClass('is-active')) {
                                $filters.eq(index).removeClass('is-active');
                                $filters.eq(index).find('.filter-type-content-hdr').slideUp(250);
                            } else {
                                $filters.removeClass('is-active').eq(index).addClass('is-active');
                                $filters.not('.is-active').find('.filter-type-content-hdr').slideUp(250);
                                $filters.filter('.is-active').find('.filter-type-content-hdr').slideDown(250);
                            }
                        });
                    });
                });

                var animationend = 'animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd';

                $('#toggleFilters').on('click', function(e) {
                    e.preventDefault();
                    $('#storeFilters').addClass('is-active');
                    $('body').addClass('filters-is-shown');
                });

                $('#storeFilters').find('.filter-closer').on('click', hideStoreFilters);

                function hideStoreFilters(e) {
                    if (e) {
                        e.preventDefault();
                    }

                    if ($('#storeFilters').hasClass('is-active')) {
                        $('#storeFilters')
                            .on(animationend, function() {
                                $('#storeFilters')
                                    .off(animationend)
                                    .removeClass('is-active is-hiding');
                            })
                            .addClass('is-hiding');


                        $('body').removeClass('filters-is-shown');
                    }
                }

                function distHaversine(p1, p2) {
                    var R = 6371; // earth's mean radius in km
                    var dLat = rad(p2.lat() - p1.lat());
                    var dLong = rad(p2.lng() - p1.lng());

                    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat())) * Math.sin(dLong / 2) * Math.sin(dLong / 2);
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    var d = R * c;

                    return d.toFixed(3);
                }

                function rad(x) {
                    return x * Math.PI / 180;
                }

                function ascendingDistance(a, b) {
                    var distA = a.distance,
                        distB = b.distance;

                    // if(distA === 'nope') distA = 9999999;
                    // if(distB === 'nope') distB = 9999999;
                    return (distA - distB);
                }

                function replaceStr(targetArr, targetStr, replaceStr) {
                    while (targetArr.indexOf(targetStr) > -1) {
                        targetArr[targetArr.indexOf(targetStr)] = replaceStr;
                    }
                }

                function queryStr() {
                    var search = window.location.search;

                    if (search.charAt(0) === '?') {
                        search = search.substr(1);
                    }

                    var splitSearch = search.split('&'),
                        searchProps = {};

                    $.each(splitSearch, function(index, keyValStr) {
                        var splitKeyValStr = keyValStr.split('=');

                        searchProps[splitKeyValStr[0]] = splitKeyValStr[1];
                    });

                    return searchProps;
                }
            });
        })(jQuery);
    }
</script>